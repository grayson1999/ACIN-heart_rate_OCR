# ACIN 연구실 - 비접촉식 심박수 측정 연구용 프로그램

> **OpenCV와 PaddleOCR을 활용한 의료기기 디스플레이 자동 인식 시스템**

## 📋 목차

- [실험 환경 설정](#실험-환경-설정)
- [영상 전처리 과정](#영상-전처리-과정)
- [시간 데이터 인식](#시간-데이터-인식)
- [심박수 데이터 인식](#심박수-데이터-인식)
- [결과 및 성능](#결과-및-성능)
- [버전 히스토리](#버전-히스토리)

## ⚙️ 실험 환경 설정

### 📌 시스템 요구사항
- **지원 기기**: 닥터힐링 산소포화도 측정기 전용
- **촬영 환경**: 실내 안정된 조명 환경
- **데이터 형식**: MP4 영상 입력, CSV 결과 출력

### 🎯 촬영 가이드라인

| 항목 | 요구사항 | 비고 |
|------|----------|------|
| **측정기 위치** | 영상 하단부 (height/2 이하) | 심박수 측정기 우선 배치 |
| **촬영 거리** | 15-17cm (iPhone12 기준) | 20cm 이상 시 인식률 저하 |
| **수평 유지** | 촬영기기와 디스플레이 수평 | 기울기 보정 한계로 인한 필수 조건 |
| **초점 설정** | 심박수 측정기 중심 | 시간 데이터 대비 인식률 낮음 |

### ⚠️ 제한사항
1. **데이터 품질**: 시간 데이터는 노이즈 최소화, 심박수 데이터는 완전한 노이즈 제거 필요
2. **색상 의존성**: 특정 색상 범위에서만 동작 (HSV 색공간 기반)
3. **단일 기기 지원**: 다른 의료기기에서는 별도 캘리브레이션 필요

## 🔄 영상 전처리 과정

### 1️⃣ 원본 이미지 입력
<p align="center"><img src="./img/img_ori.png" width="500" height="280"></p>

### 2️⃣ 가우시안 블러 + 적응형 임계값 처리
- **GaussianBlur**: 노이즈 제거 및 중앙값 가중치 적용으로 주변부 흐림 처리
- **Adaptive Threshold**: 지역적 특성을 고려한 이진화 처리

<p align="center"><img src="./img/img_thresh.png" width="500" height="280"></p>

### 3️⃣ 윤곽선 검출 (Contour Detection)
OpenCV의 `findContours`를 활용한 객체 경계 검출

<p align="center"><img src="./img/findcontour.png" width="500" height="280"></p>

### 4️⃣ 바운딩 박스 변환
검출된 윤곽선을 사각형 영역으로 변환하여 ROI 추출 준비

<p align="center"><img src="./img/boundingrect.png" width="500" height="280"></p>

## 🕐 시간 데이터 인식

### 1️⃣ 시간 데이터 후보군 검출
**필터링 조건**: 사각형 넓이, 가로세로 비율 기반 1차 선별
- 최소 넓이: 200px²
- 가로세로 비율: 0.2 ~ 1.0
- 최소 크기: 너비 2px, 높이 9px

<p align="center"><img src="./img/time_data_possible_contours.png" width="500" height="280"></p>

### 2️⃣ 패턴 매칭을 통한 최종 후보 선정
**시간 디스플레이 특성 활용**: 연속된 숫자들의 배열 및 크기 유사성 검증
- 대각선 거리 기반 근접성 검사
- 각도 차이 및 면적 유사도 분석
- 최소 3개 이상 매칭 시 유효 판정

<p align="center"><img src="./img/matched_result_idx.png" width="500" height="280"></p>

### 3️⃣ 회전 보정 및 ROI 추출
**기하학적 변환**: 검출된 시간 영역의 기울기 보정 후 이미지 크롭
- 패딩 적용으로 주변 컨텍스트 포함
- 회전 행렬 적용으로 수평 정렬
- 최적 크기로 이미지 자르기

<p align="center"><img src="./img/time_plate_imgs.png" width="500" height="280"></p>

## 💓 심박수 데이터 인식

### 1️⃣ BPM 디스플레이 후보군 검출
**고정밀 필터링**: 심박수 디스플레이의 물리적 특성 반영
- 최소 넓이: 1000px²
- 가로세로 비율: 1.4 ~ 1.7
- 최소 크기: 너비 100px, 높이 80px

<p align="center"><img src="./img/bpm_possible_contours.png" width="500" height="280"></p>

### 2️⃣ 위치 기반 필터링
**공간적 제약 조건**: 촬영 환경의 물리적 배치 고려
- 검출 영역: 화면 하단부 (y > height/2)
- 측정기 위치 고정으로 인한 영역 제한

### 3️⃣ HSV 색공간 기반 전처리
**색상 필터링 + 이미지 반전**: 녹색 디스플레이 최적화
- HSV 범위: H(30-90), S(40-255), V(40-200)
- 비트와이즈 연산을 통한 마스크 적용
- 색상 반전으로 OCR 인식률 향상

<p align="center"><img src="./img/inversion_gray.png" width="500" height="280"></p>

## 📊 결과 및 성능

### 🔍 OCR 처리 과정
1. **PaddleOCR 기반 텍스트 인식**
   - 전처리된 이미지를 PaddleOCR에 입력
   - 인식 실패 시 빈 문자열 반환으로 안정성 확보

2. **데이터 검증 및 필터링**
   - **시간 데이터**: 12자리 형식(HH:MM:SS:mmm) + 콜론 위치 검증
   - **심박수 데이터**: 60-180 범위 제한 + 이전값 대비 급변 감지
   - 이상치 제거로 데이터 신뢰성 향상

3. **동기화된 데이터 출력**
   - 시간-심박수 쌍 데이터 매칭 보장
   - 0.5초 간격 평균값 계산으로 노이즈 감소

### 📈 성능 개선 히스토리

#### Ver 1.0 → Ver 1.2 성능 비교

| 버전 | 인식률 | 처리속도 | 주요 개선사항 |
|------|--------|----------|---------------|
| **Ver 1.0** | 75% | 기준 | 기본 OCR 구현 |
| **Ver 1.1** | 85% | +15% | 전역 BPM 인식, 필터링 개선 |
| **Ver 1.2** | 95% | +20% | 색상 추출, CSV 출력 |

<div align="center">
<img src="./img/result.png" width="300" height="380">
<img src="./img/result1.1.png" width="300" height="410">
<img src="./img/result1.2.png" width="350" height="410">
</div>

## 📝 버전 히스토리

### 🔄 Ver 1.1 (2022.03)
- **공간 인식 확장**: BPM 측정기 인식 영역을 좌측 하단 → 전체 하단부로 확대
- **필터링 로직 개선**: `img_to_string` 함수 내 BPM 검증 알고리즘 고도화
- **색상 범위 조정**: HSV 색공간 임계값 최적화
- **데이터 평활화**: 0.5초 단위 평균값 계산 도입

### 🚀 Ver 1.2 (2022.06) 
- **의존성 관리**: `requirements.txt` 파일 추가로 환경 구축 자동화
- **비접촉 인식**: 추가 조치 없이 자연스러운 BPM 인식 구현

<div align="center">
<img src="./img/inversion_size_ori.png" width="260" height="150">
<img src="./img/inversion_gray_2.png" width="260" height="150">
</div>

- **데이터 출력**: CSV 형태 결과 저장 기능 구현

### ⚡ Ver 2.0 (2022.09)
- **모듈화**: 형식 변환 알고리즘과 OCR 처리 모듈 분리로 유지보수성 향상

### 🔧 Ver 2.1 (2022.10)
- **시간 인식 안정성**: 시간 데이터 인식 오류 수정 및 검증 로직 강화

### 🔗 Ver 2.1.1 (2022.11)
- **파일 시스템**: [ACIN-Finding_error_rate](https://github.com/Grayson1999/ACIN-Finding_error_rate) 프로젝트 연동을 위한 저장 구조 표준화

### 🎯 Ver 2.1.2 (2022.12) - Current
- **초기화 문제 해결**: 첫 프레임 인식 실패 시 전체 인식 중단 현상 수정
- **인식 범위 확대**: 추가 인식 영역 설정으로 robustness 향상  
- **방어적 색상 설정**: 초기 인식 정확도 향상을 위한 HSV 범위 보수적 조정

---

## 🛠️ 기술 스택
- **Python 3.x** - 메인 개발 언어
- **OpenCV 4.5.5** - 컴퓨터 비전 및 이미지 처리
- **PaddleOCR 2.4** - 광학 문자 인식
- **Pandas 1.4.1** - 데이터 처리 및 분석
- **NumPy 1.22.2** - 수치 연산 및 배열 처리

## 📄 관련 연구
- **논문**: "영상처리 기반 생체 정보 측정 방법 구현 및 분석" (2022)
- **연구기관**: ACIN 연구실
- **응용분야**: 비접촉식 생체신호 측정, 의료 AI
